<!DOCTYPE html>
<html lang="pt" dir="ltr">
	<head>
		{% load static %}
		<meta charset="utf-8" />
		<link rel="icon" type="image/png" href="{% static
		"./img/favicon-32x32.png"%}" sizes="32x32" /> <link rel="icon"
		type="image/png" href="{% static "./img/favicon-16x16.png"%}"
		sizes="16x16" />
		<meta
			name="viewport"
			content="user-scalable=no, initial-scale=1, height=device-height"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="{% static "./css/request.css"%}">
		<title>Pedido</title>
	</head>

	<body>
		<main>
			<section id="home">
				<div class="intro">
					<a href="/"
						><img src="{% static "./img/logo.png"%}"
						alt="logo-ponto-vermelho"></a
					>
				</div>

				<a href="/" id="leave">Sair</a>

				<div class="request">
					<form
						class="request-kind"
						method="post"
						action="clothing.html"
					>
						<div class="tab">
							<div class="kind-container">
								<h2>Tipo de Pedido:</h2>

								<div class="kind-check">
									<label class="container"
										>Requisição interna (CVP-Braga)
										<input
											type="radio"
											name="check"
											value="0"
											id="op0"
										/>
										<span class="checkmark"></span>
									</label>
									<br />
									<br />
									<label class="container"
										>Individual
										<input
											type="radio"
											name="check"
											value="1"
											id="op1"
										/>
										<span class="checkmark"></span>
									</label>
									<br />
									<br />
									<label class="container"
										>Agregado
										<input
											type="radio"
											name="check"
											value="2"
											id="op2"
										/>
										<span class="checkmark"></span>
									</label>
								</div>
							</div>
						</div>
						<div class="tab">
							<div class="id-container">
								<h2>Identificação do Beneficiário:</h2>

								<div class="id-field">
									<label for="name1"
										>Nome do/a técnico/a de
										referência:</label
									>
									<br />
									<input
										id="name1"
										type="text"
										name="name1"
										required
									/>
								</div>

								<div class="id-field">
									<label for="name2"
										>Nome do/a beneficiário/a
										titular:</label
									>
									<br />
									<input type="text" name="name2" required />
								</div>

								<div class="id-nums">
									<div class="id-field num">
										<label for="cc">Nº do CC:</label>
										<br />
										<input
											type="number"
											name="cc"
											required
										/>
									</div>
									<div class="id-field num">
										<label for="phone"
											>Nº de telefone:</label
										>
										<br />
										<input
											type="number"
											name="phone"
											required
										/>
									</div>
								</div>
							</div>
						</div>

						<div class="request-but">
							<a id="back" onclick="nextPrev(-1)">
								<img src="{% static "./img/back.svg"%}"
								alt="back-arrow" />
							</a>
							<a
								class="plus-button"
								id="plus-button"
								onclick="addPedido()"
							>
								<p>+</p>
							</a>
							<a id="next" onclick="nextPrev(1)">
								<img src="{% static "./img/next.svg"%}"
								alt="next-arrow" />
							</a>
							<!---	<button id="sub" style="display: none;">
								<button type="submit" name="button">
									<img src="{% static "./img/next.svg"%}"
									alt="next-arrow" />
								</button>
								</button> -->
						</div>
						<div class="tab">
							<div
								class="clothing-container"
								id="clothing-container"
							>
								<h2>Pedido:</h2>
								<div class="product-div" id="product-div">
									<div class="clothing-line">
										<div class="clothing-field">
											<label for="description"
												>Descrição do Produto:</label
											>
											<br />
											<select
												name="description"
												id="description"
												onchange="tipoProdutoChanged(0)"
											>
												{% for product in products %}

												<option
													value="{{product.tipoProduto}}"
													>{{product.tipoProduto}}</option
												>
												{% endfor %}
											</select>
										</div>

										<div class="clothing-field">
											<label for="quantity"
												>Quantidade:</label
											>
											<br />
											<select
												name="quantity"
												id="quantity"
											>
												<option value="1">1</option>
												<option value="2">2</option>
												<option value="3">2</option>
												<option value="4">3</option>
											</select>
										</div>
									</div>

									<div class="clothing-line">
										<div class="clothing-field" id="type-size-div">
											<label for="size"
												>Tipo de Tamanho:</label
											>
											<br />
											<select
												name="type-size"
												id="type-size"
												onchange="typeSizeChanged(0)"
											>
												<option value="Adulto"
													>Adulto</option
												>
												<option value="Criança"
													>Criança</option
												>
											</select>
										</div>
										<div class="clothing-field">
											<label for="size">Tamanho:</label>
											<br />
											<select name="size" id="size">
												<option value="35">35</option>
												<option value="36">36</option>
												<option value="37">37</option>
												<option value="38">38</option>
											</select>
										</div>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</section>
		</main>
		<script>
			var back = document.getElementById("back");
			var next = document.getElementById("next");
			var sub = document.getElementById("sub");

			var op0 = document.getElementById("op0");
			var op1 = document.getElementById("op1");
			var op2 = document.getElementById("op2");

			var inputs = document.getElementsByTagName("input");

			var kind = document.querySelector(".kind-container");
			var id = document.querySelector(".id-container");

			var numProdutos = 0;

			var currentTab = 0; // Current tab is set to be the first tab (0)
			showTab(currentTab); // Display the current tab

			function showTab(n) {
				var x = document.getElementsByClassName("tab");
				x[n].style.display = "block";
				if (n == 0) {
					document.getElementById("back").style.opacity = 0.3;
					document.getElementById("back").onclick = false;
				} else {
					document.getElementById("back").style.opacity = 1;
					document.getElementById("back").onclick = () =>
						nextPrev(-1);
				}
				if (n == x.length - 1) {
					document.getElementById("plus-button").style.display =
						"block";
				} else {
					console.log("Asdassdasd");
					document.getElementById("plus-button").style.display =
						"none";
				}
			}

			function nextPrev(n) {
				// This function will figure out which tab to display
				var x = document.getElementsByClassName("tab");
				// Exit the function if any field in the current tab is invalid:
				if (n == 1 && !true) return false;
				// Hide the current tab:
				x[currentTab].style.display = "none";
				// Increase or decrease the current tab by 1:
				currentTab = currentTab + n;
				// if you have reached the end of the form... :
				if (currentTab >= x.length) {
					//...the form gets submitted:
					document.getElementById("regForm").submit();
					return false;
				}
				// Otherwise, display the correct tab:
				showTab(currentTab);
			}

			function validateForm() {
				// This function deals with validation of the form fields
				var x,
					y,
					i,
					valid = true;
				x = document.getElementsByClassName("tab");
				y = x[currentTab].getElementsByTagName("input");
				// A loop that checks every input field in the current tab:
				for (i = 0; i < y.length; i++) {
					// If a field is empty...
					if (y[i].value == "") {
						// add an "invalid" class to the field:
						y[i].className += " invalid";
						// and set the current valid status to false:
						valid = false;
					}
				}
				// If the valid status is true, mark the step as finished and valid:
				if (valid) {
					document.getElementsByClassName("step")[
						currentTab
					].className += " finish";
				}
				return valid; // return the valid status
			}

			function addPedido() {
				numProdutos++;
				const newNode = document
					.getElementById("product-div")
					.cloneNode(true);

				newNode.querySelector("#description").onchange = () =>
					tipoProdutoChanged(numProdutos);
				newNode.querySelector("#type-size").onchange = () =>
					typeSizeChanged(numProdutos);

				document
					.getElementById("clothing-container")
					.appendChild(newNode);
			}

			function typeSizeChanged(num) {
				const tipoProduto = document
					.querySelectorAll(".product-div")
					[num].querySelector("#description").value;
				var myJSONList = "{{productsJSON}}".replace(
					/&(l|g|quo)t;/g,
					function (a, b) {
						return {
							l: "<",
							g: ">",
							quo: '"'
						}[b];
					}
				);

				myData = JSON.parse(myJSONList);
				const selected = myData.find(
					elem => elem.fields.tipoProduto === tipoProduto
				);

				var length = document
					.querySelectorAll(".product-div")
					[num].querySelector("#size").options.length;

				//TAMANHOS
				const selectHTML = document
					.querySelectorAll(".product-div")
					[num].querySelector("#size");

				for (i = length - 1; i >= 0; i--) {
					selectHTML.options[i] = null;
				}

				if (
					document
						.querySelectorAll(".product-div")
						[num].querySelector("#type-size").value === "Adulto"
				) {
					selected.fields.tamanhosPossiveisAdulto
						.split(",")
						.map(elem => {
							var newOption = document.createElement("option");
							newOption.text = elem.replace(/^\s+|\s+$/g, "");
							newOption.value = elem.replace(/^\s+|\s+$/g, "");
							selectHTML.options.add(newOption);
						});
				} else if (
					document
						.querySelectorAll(".product-div")
						[num].querySelector("#type-size").value === "Criança"
				) {
					selected.fields.tamanhosPossiveisCriança
						.split(",")
						.map(elem => {
							var newOption = document.createElement("option");
							newOption.text = elem.replace(/^\s+|\s+$/g, "");
							newOption.value = elem.replace(/^\s+|\s+$/g, "");
							selectHTML.options.add(newOption);
						});
				}
			}

			function tipoProdutoChanged(num) {
				const tipoProduto = document
					.querySelectorAll(".product-div")
					[num].querySelector("#description").value;
				var myJSONList = "{{productsJSON}}".replace(
					/&(l|g|quo)t;/g,
					function (a, b) {
						return {
							l: "<",
							g: ">",
							quo: '"'
						}[b];
					}
				);

				myData = JSON.parse(myJSONList);
				const selected = myData.find(
					elem => elem.fields.tipoProduto === tipoProduto
				);

				var length = document
					.querySelectorAll(".product-div")
					[num].querySelector("#quantity").options.length;

				//QUANTIDADE
				const selectHTML = document
					.querySelectorAll(".product-div")
					[num].querySelector("#quantity");

				for (i = length - 1; i >= 0; i--) {
					selectHTML.options[i] = null;
				}

				for (var i = 1; i <= selected.fields.quantidadeMaxima; i++) {
					var newOption = document.createElement("option");
					newOption.text = i.toString();
					newOption.value = i;
					selectHTML.options.add(newOption);
				}

				console.log(selected.fields.tamanhosPossiveis)

				if (selected.fields.tamanhosPossiveis) {
					document.querySelectorAll(".product-div")[num].querySelector("#type-size-div").style.display = "none";
				}else{

					document.querySelectorAll(".product-div")[num].querySelector("#type-size-div").style.display = "block";
				}
			}
		</script>
	</body>
</html>
